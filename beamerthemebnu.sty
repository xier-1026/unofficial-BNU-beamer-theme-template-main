% Custom Unofficial Beamerposter Theme: bnutheme

\ProvidesPackage{beamerthemebnu}[2025/04/04 BNU Custom Theme Unofficial]
\RequirePackage{kvoptions}
\RequirePackage{etoolbox}
\RequirePackage{fontspec} % 添加fontspec支持

\SetupKeyvalOptions{
    family=bnutheme,
    prefix=bnutheme@
}

\DeclareBoolOption[false]{presentation}
\ProcessKeyvalOptions*
\ifbnutheme@presentation
    \RequirePackage{ragged2e}
    \setbeamerfont{headline institute}{size=\Large}
    \setbeamertemplate{section in toc}[sections numbered]
\else 
% ======================
% Font Setup for LuaLaTeX
% ======================
\RequirePackage{unicode-math} % 使用unicode-math替代传统数学字体
\RequirePackage{calc}
\RequirePackage{ragged2e}
\RequirePackage{changepage}
\RequirePackage{pgffor}
\RequirePackage{xcolor}

\usefonttheme{professionalfonts}

% ======================
% Default Font Settings
% ======================
\setbeamerfont{headline title}{size=\Huge, series=\bfseries}
\setbeamerfont{headline author}{size=\Large}
\setbeamerfont{headline institute}{size=\normalsize}
\setbeamerfont{block title}{size=\large, series=\bfseries}
\setbeamerfont{heading}{series=\bfseries}
\setbeamerfont{footline}{size=\normalsize}
\setbeamerfont{frametitle}{size=\Large}
\fi 

% ======================
% Math Font Setup for LuaLaTeX
% ======================
\RequirePackage{amsmath}
% 确保数学公式使用Times风格字体
\usefonttheme{serif} % 使用衬线字体（包括数学公式）

% ======================
% Logo Management
% ======================
\newcommand{\presentationlogo}[1]{\newcommand{\insertpresentationlogo}{#1}}
\newlength{\logowidth}
\setlength{\logowidth}{10cm}

\newcommand{\logoleft}[1]{\newcommand{\insertlogoleft}{#1}}
\newcommand{\logoright}[1]{\newcommand{\insertlogoright}{#1}}

% ======================
% Header / Title Bar
% ======================
\ifbnutheme@presentation

\setbeamertemplate{title page}{
  \begin{center}
    % Title box centered with shadow
    \begin{beamercolorbox}[wd=0.85\paperwidth, rounded=true, shadow=true, center]{title box}
    \usebeamerfont{title}
    \centering
    \parbox{0.85\paperwidth}{\centering\inserttitle}
    \end{beamercolorbox}

    
    \vspace{1cm}
    {\usebeamerfont{author}\insertauthor\par}
    
    \vspace{0.5cm}
    {\usebeamerfont{institute}\insertinstitute\par}
    
    \vspace{0.5cm}
    {\usebeamerfont{date}\insertdate\par}

    \vspace{0.51cm}
    \ifdefined\insertpresentationlogo
      \insertpresentationlogo
    \fi
  \end{center}
}

%=========Presentation Header=======
\setbeamertemplate{headline}{
  \leavevmode%
  \hbox{%
    \begin{beamercolorbox}[wd=0.5\paperwidth, ht=2.5ex, dp=1.5ex, center]{headline left}%
      \centering
      \vspace{-1ex}
      \usebeamerfont{section in head/foot} \insertsectionhead
    \end{beamercolorbox}%
    \begin{beamercolorbox}[wd=0.5\paperwidth, ht=2.5ex, dp=1.5ex, center]{headline right}%
      \centering
      \vspace{-0.85ex}
      \usebeamerfont{section in head/foot}
      \ifx\insertframetitle\empty
        % Do nothing
      \else
        \ifnum\value{framenumber}=1
          % Title page: do nothing
        \else
          \ifx\insertframetitle\tableofcontentsname
            % TOC page: do nothing
          \else
            \foreach \n in {\insertsectionstartpage,...,\insertsectionendpage}{
              \ifnum\n=\insertframenumber
                \hyperlink{slide\n}{\raisebox{0.15ex}{\small$\bullet$}}
              \else
                \hyperlink{slide\n}{\color{gray!60}\raisebox{0.15ex}{\small$\bullet$}}
              \fi
              \hspace{0.2em}
            }
          \fi
        \fi
      \fi
    \end{beamercolorbox}%
  }
}

\else
%==========Poster Header=======
\setbeamertemplate{headline}{
  \begin{beamercolorbox}{headline}
    \begin{columns}
      \begin{column}{0.2\paperwidth}
        \ifdefined\insertlogoleft
        \vspace*{0.5ex}
        \hspace{7ex}
        \insertlogoleft
        \fi
      \end{column}
      \begin{column}{0.6\paperwidth}
        \centering
        \vskip2ex
        {\usebeamerfont{headline title} \inserttitle \par}
        \vskip1ex
        {\usebeamerfont{headline author} \insertauthor \par}
        \vskip0.5ex
        {\usebeamerfont{headline institute} \insertinstitute \par}
      \end{column}
      \begin{column}{0.2\paperwidth}
        \ifdefined\insertlogoright
        \vspace*{0.5ex}
        \hspace{3.5in}
        \insertlogoright
        \hspace{2ex}
        \fi
      \end{column}
    \end{columns}
    \vspace{1ex}
    \begin{beamercolorbox}[wd=\paperwidth,ht=1ex]{headline rule}
    \end{beamercolorbox}
  \end{beamercolorbox}
}
\fi

%==================== frame title ==========================
\setbeamertemplate{frametitle}{
    \vskip-0.2ex
    \ifbnutheme@presentation
        \begin{beamercolorbox}[wd=\paperwidth, ht=3ex, dp=1.5ex, shadow=true]{frametitle}
            \ifx\insertframetitle\empty
            \else
                \hbox to \paperwidth{%
                    \makebox[0.85\paperwidth][l]{%
                        \hspace{1.5ex}\usebeamerfont{frametitle}\insertframetitle%
                    }%
                    \makebox[0.15\paperwidth][r]{%
                        \raisebox{-0.5ex}{\includegraphics[height=3.0ex]{logo/bnu-logo.png}}%
                        \hspace{1ex}%
                    }%
                }
            \fi
        \end{beamercolorbox}
    \else
        \begin{beamercolorbox}[wd=\paperwidth, ht=3ex, dp=1.5ex, shadow=true]{frametitle}
            \usebeamerfont{frametitle}\hspace{1.5ex}\insertframetitle
        \end{beamercolorbox}
    \fi
    \vskip0.5ex
}

% ======================
% Footer Content
% ======================
\ifbnutheme@presentation
\setbeamerfont{author in head/foot}{size=\scriptsize}
\setbeamerfont{title in head/foot}{size=\scriptsize}
\setbeamerfont{date in head/foot}{size=\scriptsize}
\setbeamerfont{section in head/foot}{size=\scriptsize}
\setbeamerfont{subsection in head/foot}{size=\scriptsize}

%==========Presentation footer============
\setbeamertemplate{footline}{

  % ===== Bottom: Custom footer =====
  \leavevmode%
  \hbox{%
    \begin{beamercolorbox}[wd=0.2\paperwidth,ht=2.3ex,dp=1.5ex,center]{footline left}%
        \centering
        \vspace{-0.8 ex}
      \usebeamerfont{section in head/foot} \hspace{1ex}\insertshortauthor
    \end{beamercolorbox}%
    \begin{beamercolorbox}[wd=0.5\paperwidth,ht=2.3ex,dp=1.5ex,center]{footline center}%
      \centering
      \vspace{-0.8ex}
      \usebeamerfont{section in head/foot} 
      \insertshorttitle
    \end{beamercolorbox}%
    \begin{beamercolorbox}[wd=0.3\paperwidth,ht=2.3ex,dp=1.5ex,right]{footline right}%
      \centering
      \vspace{-1.2 ex}
      \usebeamerfont{section in head/foot} 
      \insertshortdate{}\hfill%
      \insertframenumber{}/\inserttotalframenumber\hspace{1ex}
    \end{beamercolorbox}%
  }
}

\else 
%=============Poster footer=============
\newcommand{\footercontent}[1]{\newcommand{\insertfootercontent}{#1}}

\setbeamertemplate{footline}{
  \ifdefined\insertfootercontent
  \begin{beamercolorbox}[wd=\paperwidth,ht=3ex,dp=2ex]{footline}
    \usebeamerfont{footline} \insertfootercontent
    \hspace{\sepwidth}
  \end{beamercolorbox}
  \fi
}
\fi
% ================= Box Settings ==============
\RequirePackage{tcolorbox}
\tcbuselibrary{skins, breakable, theorems}

% Define common tcolorbox style keys
\tcbset{
  fancyblockstyle/.style={
    enhanced,
    rounded corners,
    colframe=BNUBlue,
    coltitle=BNURed,
    colbacktitle=BNUBlue,
    title filled=true,
    boxrule=1.5pt,
    fonttitle=\bfseries,
    breakable,
    attach boxed title to top left={xshift=5mm, yshift=-2mm},
    boxed title style={rounded corners, size=small}
  }
}

\newtcolorbox{alignblock}[1]{
    \fancyblockstyle,
    title={#1},
    before upper={\raggedright} % 强制内容左对齐
}

\newtcolorbox{fancyblock}[1]{
    \fancyblockstyle,
    title={#1}
}

% ======================
% Block Styling (using tcolorbox for both presentation and poster modes)
% ======================
\setbeamertemplate{block begin}{
  \begin{tcolorbox}[fancyblockstyle, title=\insertblocktitle]
  \justifying
}
\setbeamertemplate{block end}{
  \end{tcolorbox}
  \vspace*{1ex}
}

% Alert block
\setbeamertemplate{block alerted begin}{
  \begin{tcolorbox}[fancyblockstyle, 
    colframe=red!75!black,
    colbacktitle=red!75!black,
    title=\insertblocktitle
  ]
  \justifying
}
\setbeamertemplate{block alerted end}{
  \end{tcolorbox}
  \vspace*{1ex}
}

% Example block
\setbeamertemplate{block example begin}{
  \begin{tcolorbox}[fancyblockstyle,
    colframe=green!50!black,
    colbacktitle=green!50!black,
    title=\insertblocktitle
  ]
  \justifying
}
\setbeamertemplate{block example end}{
  \end{tcolorbox}
  \vspace*{1ex}
}
%===================== Table and Images===============
\setbeamertemplate{caption}[numbered]
\setbeamertemplate{caption label separator}{:\hspace{0.3em}}
\setbeamertemplate{caption label format}{\insertcaptionname~\insertcaptionnumber\hspace{0.2em}}

%===================== Section/Subsection Colorbox Styles ===============
% 定义section页面的colorbox样式
\newcommand{\sectioncolorbox}[1]{%
  \begin{tcolorbox}[
    enhanced,
    sharp corners,
    colback=BNUBlue!20,
    colframe=BNUBlue,
    boxrule=2pt,
    arc=0mm,
    width=\textwidth,
    height=10ex,
    valign=center,
    halign=center,
    fontupper=\huge\bfseries\color{BNUBlue}
  ]
  #1
  \end{tcolorbox}%
}

% 定义subsection页面的colorbox样式
\newcommand{\subsectioncolorbox}[1]{%
  \begin{tcolorbox}[
    enhanced,
    sharp corners,
    colback=BNURed!20,
    colframe=BNURed,
    boxrule=2pt,
    arc=0mm,
    width=\textwidth,
    height=8ex,
    valign=center,
    halign=center,
    fontupper=\LARGE\bfseries\color{BNURed}
  ]
  #1
  \end{tcolorbox}%
}

%===================== Table of Content Settings===============
\AtBeginSection[]{
	\begin{frame}
    \sectioncolorbox{\Roman{section} \insertsection}
    \vspace{1ex}
		  \tableofcontents[sectionstyle=show/shaded,subsectionstyle=show/shaded/hide,subsubsectionstyle=show/shaded/hide]
	\end{frame}
}
\AtBeginSubsection[]{
	\begin{frame}
    \subsectioncolorbox{\Roman{section}-\Roman{subsection} \insertsubsection}
    \vspace{1ex}
		  \tableofcontents[sectionstyle=show/shaded,subsectionstyle=show/shaded/hide,subsubsectionstyle=show/shaded/hide]
	\end{frame}
}

\makeatletter
\patchcmd{\beamer@@frametitle}
    {\gdef\insertframetitle}
    {\hypertarget{slide\theframenumber}{}\gdef\insertframetitle}
    {}{}
\makeatother